<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte SIG Madagascar - Routes Nationales</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        #container {
            display: flex;
            height: 100vh;
        }
        
        #sidebar {
            width: 300px;
            background: #f5f5f5;
            border-right: 2px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        #sidebar h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        #rnList {
            list-style: none;
        }
        
        #rnList li {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        #rnList li:hover {
            background: #e7f3ff;
            border-color: #007bff;
            transform: translateX(5px);
        }
        
        #rnList li.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
            font-weight: bold;
        }
        
        #rnList li.loading {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }
        
        #map {
            flex: 1;
            background: #e8e8e8;
        }
        
        .search-box {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .info-panel {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        
        .info-panel h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .info-panel p {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Leaflet popup style */
        .leaflet-popup-content {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
        }
        
        .leaflet-popup-content h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Sidebar -->
        <div id="sidebar">
            <h2>üìç Routes Nationales</h2>
            
            <input 
                type="text" 
                id="searchInput" 
                class="search-box" 
                placeholder="Chercher une RN..."
                autocomplete="off"
            >
            
            <ul id="rnList"></ul>
            
            <div class="info-panel">
                <h3>‚ÑπÔ∏è Informations</h3>
                <p id="infoRN">Cliquez sur une RN pour voir ses d√©tails</p>
                <p id="infoSimba" style="margin-top: 10px; color: #e74c3c;"></p>
            </div>
        </div>
        
        <!-- Map -->
        <div id="map"></div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // === Variables globales ===
        let map;
        let rnLayers = {}; // {rnName: GeoJSON Layer}
        let simbaLayers = {}; // {rnName: Array of markers}
        let allRNData = [];
        let currentSelectedRN = null;
        
        // === Initialisation de la carte ===
        function initMap() {
            // Centre sur Madagascar
            map = L.map('map').setView([-18.8792, 46.8696], 7);
            
            // Ajouter OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            console.log('Carte initialis√©e');
        }
        
        // === Charger les RN depuis le serveur Java ===
        function loadRNData() {
            console.log('Chargement des RN...');
            
            // Appel AJAX au serveur Java
            fetch('/api/rn/all')
                .then(response => {
                    if (!response.ok) throw new Error('Erreur r√©seau: ' + response.status);
                    return response.json();
                })
                .then(data => {
                    allRNData = data;
                    displayRNList(data);
                    console.log('RN charg√©es:', data.length);
                })
                .catch(error => {
                    console.warn('Erreur chargement RN (fallback GeoJSON):', error);
                    loadRNFromGeoJSON();
                });
        }
        
        // === Fallback: Charger depuis GeoJSON local ===
        function loadRNFromGeoJSON() {
            fetch('./rn.geojson')
                .then(response => response.json())
                .then(data => {
                    allRNData = data.features.map(feature => ({
                        id: feature.properties.id || feature.properties.name,
                        name: feature.properties.name || 'RN Unknown',
                        geometry: feature.geometry,
                        properties: feature.properties
                    }));
                    displayRNList(allRNData);
                })
                .catch(error => console.error('Erreur GeoJSON:', error));
        }
        
        // === Afficher la liste des RN ===
        function displayRNList(rnList) {
            const rnListEl = document.getElementById('rnList');
            rnListEl.innerHTML = '';
            
            rnList.forEach(rn => {
                const li = document.createElement('li');
                li.textContent = rn.name;
                li.dataset.rnId = rn.id;
                li.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectRN(rn);
                };
                rnListEl.appendChild(li);
            });
        }
        
        // === S√©lectionner une RN ===
        function selectRN(rn) {
            console.log('S√©lection de RN:', rn.name);
            
            // Nettoyer la s√©lection pr√©c√©dente
            if (currentSelectedRN) {
                clearRNHighlight(currentSelectedRN.id);
            }
            
            currentSelectedRN = rn;
            
            // Mettre √† jour l'UI
            document.querySelectorAll('#rnList li').forEach(li => {
                li.classList.remove('active');
            });
            document.querySelector(`[data-rn-id="${rn.id}"]`)?.classList.add('active');
            
            // Afficher la RN sur la carte
            displayRNOnMap(rn);
            
            // Charger les Simba de cette RN
            loadSimbaForRN(rn.id);
            
            // Afficher les infos
            document.getElementById('infoRN').innerHTML = `<strong>${rn.name}</strong> s√©lectionn√©e`;
        }
        
        // === Afficher RN sur la carte ===
        function displayRNOnMap(rn) {
            // Cr√©er la g√©om√©trie si elle n'existe pas
            if (!rnLayers[rn.id]) {
                const style = {
                    color: '#28a745',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '0'
                };
                
                const layer = L.geoJSON(rn.geometry, { 
                    style: style,
                    onEachFeature: (feature, layer) => {
                        layer.bindPopup(`<h3>${rn.name}</h3>`);
                    }
                }).addTo(map);
                
                rnLayers[rn.id] = layer;
            }
            
            // Zoom sur la RN
            const bounds = L.geoJSON(rn.geometry).getBounds();
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        // === Charger les Simba d'une RN ===
        function loadSimbaForRN(rnId) {
            document.getElementById('infoSimba').innerHTML = '<span class="loading-spinner"></span> Chargement des d√©g√¢ts...';
            
            fetch(`/api/simba/byRN/${rnId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Simba charg√©s:', data);
                    displaySimbaOnMap(rnId, data);
                    document.getElementById('infoSimba').innerHTML = 
                        `<strong style="color: #e74c3c;">üî¥ ${data.length} d√©g√¢ts trouv√©s</strong>`;
                })
                .catch(error => {
                    console.error('‚ùå Erreur Simba:', error);
                    document.getElementById('infoSimba').innerHTML = 
                        `<strong style="color: #e74c3c;">‚ùå Erreur: ${error.message}</strong><br/>V√©rifier console (F12)`;
                });
        }
        
        // === Afficher les Simba sur la carte ===
        function displaySimbaOnMap(rnId, simbaList) {
            // Nettoyer les anciens markers
            if (simbaLayers[rnId]) {
                simbaLayers[rnId].forEach(marker => map.removeLayer(marker));
            }
            
            simbaLayers[rnId] = [];
            
            simbaList.forEach(simba => {
                // Cr√©er un marker rouge pour chaque Simba
                const marker = L.circleMarker([simba.latitude, simba.longitude], {
                    radius: 8,
                    fillColor: '#e74c3c',
                    color: '#c0392b',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.7
                }).addTo(map);
                
                // Popup avec infos
                const popupContent = `
                    <h3>${simba.descriptions}</h3>
                    <p><strong>PK:</strong> ${simba.pkDebut} - ${simba.pkFin}</p>
                    <p><strong>Surface:</strong> ${simba.surface}m¬≤</p>
                    <p><strong>Profondeur:</strong> ${simba.profondeur}m</p>
                    <p><strong>Taux Ralentissement:</strong> ${simba.tauxRalentissement}%</p>
                `;
                marker.bindPopup(popupContent);
                
                simbaLayers[rnId].push(marker);
            });
        }
        
        // === Nettoyer la mise en √©vidence d'une RN ===
        function clearRNHighlight(rnId) {
            if (rnLayers[rnId]) {
                map.removeLayer(rnLayers[rnId]);
                delete rnLayers[rnId];
            }
            
            if (simbaLayers[rnId]) {
                simbaLayers[rnId].forEach(marker => map.removeLayer(marker));
                delete simbaLayers[rnId];
            }
        }
        
        // === Recherche ===
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            document.querySelectorAll('#rnList li').forEach(li => {
                const matches = li.textContent.toLowerCase().includes(query);
                li.style.display = matches ? 'block' : 'none';
            });
        });
        
        // === Initialisation ===
        window.addEventListener('load', () => {
            initMap();
            loadRNData();
        });
    </script>
</body>
</html>
